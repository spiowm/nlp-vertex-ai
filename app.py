import os
import gradio as gr
from google import genai
import config

client = genai.Client(
    vertexai=True,
    project=config.GCP_PROJECT_ID,
)

SYSTEM_PROMPT = """–¢–∏ - –µ–∫—Å–ø–µ—Ä—Ç –∑ –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—ñ–≤. –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è - –ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ —Ç–µ–∫—Å—Ç —É –∑–∞–¥–∞–Ω–æ–º—É —Å—Ç–∏–ª—ñ.

–í–ê–ñ–õ–ò–í–û: –í–∏–¥–∞–π –õ–ò–®–ï –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∂–æ–¥–Ω–∏—Ö –≤—Å—Ç—É–ø—ñ–≤, –ø–æ—è—Å–Ω–µ–Ω—å —á–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤. –ù–µ –ø–∏—à–∏ "–û—Å—å –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–π —Ç–µ–∫—Å—Ç", "–ó–≤–∏—á–∞–π–Ω–æ", "–û—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç" —Ç–æ—â–æ. –ü—Ä–æ—Å—Ç–æ –≤–∏–¥–∞–π –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–π —Ç–µ–∫—Å—Ç —ñ –≤—Å–µ."""

STYLE_INSTRUCTIONS = {
    "–û—Ñ—ñ—Ü—ñ–π–Ω–∏–π": "–ü–µ—Ä–µ–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –≤ –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–º—É, –¥—ñ–ª–æ–≤–æ–º—É —Å—Ç–∏–ª—ñ. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ñ–æ—Ä–º–∞–ª—å–Ω—É –ª–µ–∫—Å–∏–∫—É.",
    "–†–æ–∑–º–æ–≤–Ω–∏–π": "–ü–µ—Ä–µ–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –≤ –Ω–µ–≤–∏–º—É—à–µ–Ω–æ–º—É, —Ä–æ–∑–º–æ–≤–Ω–æ–º—É —Å—Ç–∏–ª—ñ. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –ø—Ä–æ—Å—Ç–æ—Ä—ñ—á–Ω—É –º–æ–≤—É.",
    "–ü—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏": "–ü–µ—Ä–µ–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ—é –º–æ–≤–æ—é, –∑—Ä–æ–∑—É–º—ñ–ª–æ—é –Ω–∞–≤—ñ—Ç—å –¥–∏—Ç–∏–Ω—ñ.",
    "–ü–æ–µ—Ç–∏—á–Ω–∏–π": "–ü–µ—Ä–µ–ø–∏—à–∏ —Ç–µ–∫—Å—Ç —É –ø–æ–µ—Ç–∏—á–Ω–æ–º—É —Å—Ç–∏–ª—ñ –∑ –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏ —Ç–∞ –æ–±—Ä–∞–∑–Ω—ñ—Å—Ç—é.",
}

def transform_text(text, style):
    if not text or not text.strip():
        return "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è."

    instruction = STYLE_INSTRUCTIONS.get(style, STYLE_INSTRUCTIONS["–ü—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏"])
    prompt = f"{SYSTEM_PROMPT}\n\n{instruction}\n\n–¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è:\n{text}"

    response = client.models.generate_content(
        model=config.MODEL_NAME,
        contents=prompt
    )

    return response.text.strip()

with gr.Blocks() as demo:
    gr.Markdown("# üìù –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç—ñ–≤")
    gr.Markdown("–ü–µ—Ä–µ–ø–∏—Å—É–π—Ç–µ —Ç–µ–∫—Å—Ç–∏ —É —Ä—ñ–∑–Ω–∏—Ö —Å—Ç–∏–ª—è—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é AI")

    with gr.Row():
        with gr.Column():
            input_text = gr.Textbox(
                label="–í—Ö—ñ–¥–Ω–∏–π —Ç–µ–∫—Å—Ç",
                placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç, —è–∫–∏–π –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏...",
                lines=8
            )
            style_dropdown = gr.Dropdown(
                choices=list(STYLE_INSTRUCTIONS.keys()),
                value="–ü—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏",
                label="–°—Ç–∏–ª—å –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è"
            )
            transform_btn = gr.Button("‚ú® –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏", variant="primary", size="lg")

        with gr.Column():
            output_text = gr.Textbox(
                label="–†–µ–∑—É–ª—å—Ç–∞—Ç",
                lines=8,
                interactive=False
            )

    gr.Examples(
        examples=[
            ["–ü—Ä–æ—à—É –Ω–∞–¥–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é —â–æ–¥–æ —Å—Ç–∞—Ç—É—Å—É –º–æ—î—ó –∑–∞—è–≤–∫–∏ –Ω–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤.", "–†–æ–∑–º–æ–≤–Ω–∏–π"],
            ["–ü—Ä–∏–≤—ñ—Ç! –ö–æ–ª–∏ –±—É–¥—É—Ç—å –≥—Ä–æ—à—ñ?", "–û—Ñ—ñ—Ü—ñ–π–Ω–∏–π"],
            ["–ö–≤–∞–Ω—Ç–æ–≤–∞ –∑–∞–ø–ª—É—Ç–∞–Ω—ñ—Å—Ç—å - —Ü–µ —Ñ—ñ–∑–∏—á–Ω–µ —è–≤–∏—â–µ, –ø—Ä–∏ —è–∫–æ–º—É –∫–≤–∞–Ω—Ç–æ–≤—ñ —Å—Ç–∞–Ω–∏ –¥–≤–æ—Ö —á–∏ –±—ñ–ª—å—à–µ –æ–±'—î–∫—Ç—ñ–≤ –≤–∏—è–≤–ª—è—é—Ç—å—Å—è –≤–∑–∞—î–º–æ–∑–∞–ª–µ–∂–Ω–∏–º–∏.", "–ü—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏"],
        ],
        inputs=[input_text, style_dropdown],
    )

    transform_btn.click(
        fn=transform_text,
        inputs=[input_text, style_dropdown],
        outputs=output_text
    )

if __name__ == "__main__":
    port = int(os.getenv("PORT", 7860))
    demo.launch(
        server_name="0.0.0.0",
        server_port=port,
        theme=gr.themes.Soft()
    )
